var CivicChat=(()=>{var d=(u,s,a)=>new Promise((c,o)=>{var g=i=>{try{l(a.next(i))}catch(r){o(r)}},f=i=>{try{l(a.throw(i))}catch(r){o(r)}},l=i=>i.done?c(i.value):Promise.resolve(i.value).then(g,f);l((a=a.apply(u,s)).next())});(function(u,s){"use strict";function a(t,e=s){return e.querySelector(t)}function c(t,e,n){if(!t||!t.dataset)return n;let h=t.dataset[e];return h!==void 0?h:n}function o(){return"civic-"+Math.random().toString(36).substr(2,9)}function g(t){return d(this,null,function*(){try{let e=yield fetch(t,{credentials:"same-origin",headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Config load failed: "+e.status);return yield e.json()}catch(e){return console.warn("[CivicChat] Config load failed:",e),{}}})}function f(t){return d(this,null,function*(){if(!t||t==="false")return!0;try{return(yield fetch(t,{method:"GET",credentials:"same-origin"})).ok}catch(e){return console.warn("[CivicChat] Consent check failed:",e),!1}})}function l(t,e){if(s.querySelector("style[data-civic-chat]"))return;let n=s.createElement("style");n.setAttribute("data-civic-chat",""),e&&n.setAttribute("nonce",e),n.textContent=t,s.head.appendChild(n)}function i(t={}){this.options=t,this.id=o(),this.isOpen=!1,this.messages=[],this.ready=!1,this.initialize()}i.prototype.initialize=function(){this.createToggleButton(),this.createWidget(),this.bindEvents(),this.loadInitialData()},i.prototype.createToggleButton=function(){this.toggleButton=s.createElement("button"),this.toggleButton.className="civic-chat__toggle",this.toggleButton.innerHTML="\u{1F4AC}",this.toggleButton.setAttribute("aria-label","Open chat"),s.body.appendChild(this.toggleButton)},i.prototype.createWidget=function(){this.container=s.createElement("div"),this.container.className="civic-chat civic-chat--hidden",this.container.id=this.id,this.container.innerHTML=`
            <div class="civic-chat__header">
                <h3 class="civic-chat__title">${this.options.title||"Civic Chat"}</h3>
                <button class="civic-chat__close" aria-label="Close chat">\xD7</button>
            </div>
            <div class="civic-chat__messages"></div>
            <div class="civic-chat__input-area">
                <input type="text" class="civic-chat__input" placeholder="Type your message..." />
                <button class="civic-chat__send">Send</button>
            </div>
            <div class="civic-chat__consent" style="display: none;">
                <p>You need to accept the chat terms to continue.</p>
                <button class="civic-chat__consent-button">Accept</button>
            </div>
        `,s.body.appendChild(this.container),this.messagesContainer=a(".civic-chat__messages",this.container),this.input=a(".civic-chat__input",this.container),this.sendButton=a(".civic-chat__send",this.container),this.closeButton=a(".civic-chat__close",this.container),this.consentSection=a(".civic-chat__consent",this.container),this.consentButton=a(".civic-chat__consent-button",this.container)},i.prototype.bindEvents=function(){this.sendButton.addEventListener("click",()=>this.sendMessage()),this.input.addEventListener("keypress",t=>{t.key==="Enter"&&this.sendMessage()}),this.closeButton.addEventListener("click",()=>this.hide()),this.consentButton.addEventListener("click",()=>this.handleConsent()),this.toggleButton.addEventListener("click",()=>this.toggle()),s.addEventListener("keydown",t=>{t.key==="Escape"&&this.isOpen&&this.hide()})},i.prototype.loadInitialData=function(){var t=this,e=this.options.configUrl;e?g(e).then(function(n){t.options=Object.assign({},t.options,n),t.checkConsent()}).catch(function(){t.checkConsent()}):this.checkConsent()},i.prototype.checkConsent=function(){var t=this,e=this.options.consentEndpoint;f(e).then(function(n){!n&&e&&e!=="false"?t.showConsentPrompt():(t.ready=!0,t.addMessage("bot",t.options.welcomeMessage||"Hello! How can I help you today?"))})},i.prototype.showConsentPrompt=function(){this.consentSection.style.display="block",this.input.disabled=!0,this.sendButton.disabled=!0},i.prototype.handleConsent=function(){var t=this,e=this.options.consentEndpoint;e&&fetch(e,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json"}}).then(function(n){n.ok&&(t.consentSection.style.display="none",t.input.disabled=!1,t.sendButton.disabled=!1,t.ready=!0,t.addMessage("bot","Thank you! How can I help you today?"))}).catch(function(n){console.error("[CivicChat] Consent submission failed:",n)})},i.prototype.show=function(){if(!this.ready&&this.consentSection.style.display!=="block"){this.showConsentPrompt();return}this.container.classList.remove("civic-chat--hidden"),this.isOpen=!0,this.toggleButton.innerHTML="\u2715",this.toggleButton.setAttribute("aria-label","Close chat"),setTimeout(()=>this.input.focus(),100)},i.prototype.hide=function(){this.container.classList.add("civic-chat--hidden"),this.isOpen=!1,this.toggleButton.innerHTML="\u{1F4AC}",this.toggleButton.setAttribute("aria-label","Open chat")},i.prototype.toggle=function(){this.isOpen?this.hide():this.show()},i.prototype.addMessage=function(t,e){var n={id:o(),sender:t,text:e,timestamp:new Date};this.messages.push(n),this.renderMessage(n),this.scrollToBottom()},i.prototype.renderMessage=function(t){var e=s.createElement("div");e.className="civic-chat__message civic-chat__message--"+t.sender,e.textContent=t.text,this.messagesContainer.appendChild(e)},i.prototype.showTypingIndicator=function(){var t=s.createElement("div");t.className="civic-chat__typing",t.textContent="Typing...",t.id="typing-indicator",this.messagesContainer.appendChild(t),this.scrollToBottom()},i.prototype.hideTypingIndicator=function(){var t=a("#typing-indicator",this.messagesContainer);t&&t.remove()},i.prototype.sendMessage=function(){var t=this.input.value.trim();if(!(!t||!this.ready)){this.addMessage("user",t),this.input.value="",this.sendButton.disabled=!0,this.showTypingIndicator();var e=this;setTimeout(function(){e.hideTypingIndicator(),e.sendButton.disabled=!1,e.addMessage("bot",'I received: "'+t+'". This is a demo response from the widget.')},1e3+Math.random()*1e3)}},i.prototype.scrollToBottom=function(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight},i.prototype.destroy=function(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.toggleButton&&this.toggleButton.parentNode&&this.toggleButton.parentNode.removeChild(this.toggleButton)};function r(t){return d(this,null,function*(){var e=(t==null?void 0:t.el)||a("#civic-chat");if(!e)return console.warn("[CivicChat] No element found for initialization"),null;var n={apiUrl:(t==null?void 0:t.apiUrl)||c(e,"apiUrl","/chat"),consentEndpoint:(t==null?void 0:t.consentEndpoint)||c(e,"consentEndpoint","/accept"),configUrl:(t==null?void 0:t.configUrl)||c(e,"configUrl",""),title:(t==null?void 0:t.title)||c(e,"title","Civic Chat"),welcomeMessage:(t==null?void 0:t.welcomeMessage)||c(e,"welcomeMessage","Hello! How can I help you today?"),lang:(t==null?void 0:t.lang)||c(e,"lang","en")},h=s.currentScript,p=h&&h.getAttribute("nonce")||(t==null?void 0:t.nonce);t!=null&&t.useExternalCSS||console.log("[CivicChat] Styles should be loaded via external CSS file for CSP compliance");var v=new i(n);return(t==null?void 0:t.autoShow)!==!1&&setTimeout(function(){v.ready&&v.show()},500),v})}u.CivicChat={init:r,CivicChatWidget:i}})(window,document);})();
